{% extends "base.html" %}
{% load static %}

{% block content %}
<h2>í•™ë¶€ëª¨ ëŒ€ì‹œë³´ë“œ</h2>

{% if student %}
    <!-- ìµœê·¼ ê³¼ì œ ì •ë³´ì™€ ì½”ë©˜íŠ¸ -->
    {% if latest_assignment %}
    <div style="margin-bottom: 20px;">
      <h4>ìµœê·¼ ê³¼ì œ ({{ latest_assignment.date|date:"Yë…„ mì›” dì¼" }})</h4>
      <ul>
        {% if latest_assignment.task1_name %}<li>ê³¼ì œ1: {{ latest_assignment.task1_name }}</li>{% endif %}
        {% if latest_assignment.task2_name %}<li>ê³¼ì œ2: {{ latest_assignment.task2_name }}</li>{% endif %}
        {% if latest_assignment.task3_name %}<li>ê³¼ì œ3: {{ latest_assignment.task3_name }}</li>{% endif %}
        {% if latest_assignment.task4_name %}<li>ê³¼ì œ4: {{ latest_assignment.task4_name }}</li>{% endif %}
        {% if latest_assignment.task5_name %}<li>ê³¼ì œ5: {{ latest_assignment.task5_name }}</li>{% endif %}
      </ul>
      <p><strong>ì½”ë©˜íŠ¸:</strong></p>
      <p style="white-space: pre-wrap;">{{ latest_assignment.comment }}</p>

      {% if latest_submission %}
        <p><strong>ì´í–‰ë¥  (0~100):</strong></p>
        <ul>
          {% if latest_assignment.task1_name %}<li>{{ latest_assignment.task1_name }} â†’ {{ latest_submission.completion_rate1 }}%</li>{% endif %}
          {% if latest_assignment.task2_name %}<li>{{ latest_assignment.task2_name }} â†’ {{ latest_submission.completion_rate2 }}%</li>{% endif %}
          {% if latest_assignment.task3_name %}<li>{{ latest_assignment.task3_name }} â†’ {{ latest_submission.completion_rate3 }}%</li>{% endif %}
          {% if latest_assignment.task4_name %}<li>{{ latest_assignment.task4_name }} â†’ {{ latest_submission.completion_rate4 }}%</li>{% endif %}
          {% if latest_assignment.task5_name %}<li>{{ latest_assignment.task5_name }} â†’ {{ latest_submission.completion_rate5 }}%</li>{% endif %}
        </ul>
      {% else %}
        <p style="color:red;">ì´í–‰ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
      {% endif %}
    </div>
    {% endif %}

    <!-- ë‘ ê°œì˜ ë§í¬: ëª¨ë“  ì‹œí—˜ ë³´ê¸°, ëª¨ë“  ê³¼ì œ ë³´ê¸° -->
    <p>
      <a href="{% url 'all_exams_view' student.id %}" target="_blank" style="margin-right:10px;">ëª¨ë“  ì‹œí—˜ ë³´ê¸°</a>
      <a href="{% url 'all_assignments_view' student.id %}" target="_blank">ëª¨ë“  ê³¼ì œ ë³´ê¸°</a>
    </p>

    <!-- ìµœê·¼ 10íšŒ ì‹œí—˜ ê·¸ë˜í”„ -->
    <div style="width: 80%; max-width: 800px; height: 400px; margin: auto;">
        <canvas id="recentExamChart"></canvas>
    </div>
    <p id="noDataMessage" style="display: none; color: red;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>

    <!-- ì „ì²´ ì‹œí—˜ ê·¸ë˜í”„ -->
    <div style="width: 80%; max-width: 800px; height: 400px; margin: auto; margin-top: 30px;">
        <canvas id="overallExamChart"></canvas>
    </div>
    <p id="noDataMessage2" style="display: none; color: red;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>

{% else %}
    <p>ë°°ì •ëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</p>
{% endif %}

<!-- Chart.js ìŠ¤í¬ë¦½íŠ¸ -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
/* ìµœê·¼ 10íšŒ ì‹œí—˜ ì°¨íŠ¸ */
fetch("{% url 'exam_chart_data' %}")
    .then(response => response.json())
    .then(data => {
        if (!data.exam_names || data.exam_names.length === 0) {
            document.getElementById("noDataMessage").style.display = "block";
            return;
        }
        const ctx = document.getElementById("recentExamChart").getContext("2d");
        new Chart(ctx, {
            type: "line",
            data: {
                labels: data.exam_names,
                datasets: [
                    {
                        label: "í•™ìƒ ì„±ì ",
                        data: data.student_scores,
                        borderColor: "blue",
                        backgroundColor: "rgba(0, 0, 255, 0.2)",
                        fill: true,
                        tension: 0.1,
                        pointRadius: 0
                    },
                    {
                        label: "ë°˜ í‰ê· ",
                        data: data.class_averages,
                        borderColor: "red",
                        backgroundColor: "rgba(255, 0, 0, 0.2)",
                        fill: true,
                        tension: 0.1,
                        pointRadius: 0
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    })
    .catch(err => console.error("ğŸš¨ exam_chart_data fetch error:", err));

/* ì „ì²´ ì‹œí—˜ ì°¨íŠ¸ */
fetch("{% url 'exam_chart_all_data' %}")
    .then(response => response.json())
    .then(data => {
        if (!data.exam_names || data.exam_names.length === 0) {
            document.getElementById("noDataMessage2").style.display = "block";
            return;
        }
        const ctx2 = document.getElementById("overallExamChart").getContext("2d");
        new Chart(ctx2, {
            data: {
                labels: data.exam_names,
                datasets: [
                    {
                        type: 'line',
                        label: "í•™ìƒ ì„±ì ",
                        data: data.student_scores,
                        borderColor: "green",
                        backgroundColor: "transparent",
                        tension: 0.1,
                        pointRadius: 0
                    },
                    {
                        type: 'bar',
                        label: "ë°˜ í‰ê· ",
                        data: data.class_averages,
                        backgroundColor: "rgba(255,165,0,0.5)",
                        borderColor: "orange"
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    })
    .catch(err => console.error("ğŸš¨ exam_chart_all_data fetch error:", err));
</script>
{% endblock %}
