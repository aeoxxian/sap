{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="card">
    <h2>{{ exam_result.exam.name }}</h2>
    <p style="color: #6b6b6b; margin-bottom: 1.5rem;">{{ exam_result.exam.date|date:"Yë…„ mì›” dì¼" }}</p>

    <div class="info-grid">
        <div class="info-item">
            <strong>ì´ì </strong>
            <span>{{ exam_result.total_score }} / {{ exam_result.max_score }}</span>
        </div>
        <div class="info-item">
            <strong>ë°˜ í‰ê· </strong>
            <span>{{ exam_result.exam.average }}</span>
        </div>
        <div class="info-item">
            <strong>ì„ì°¨</strong>
            <span>{{ exam_result.rank }}ë“±</span>
        </div>
        <div class="info-item">
            <strong>ì‘ì‹œ ìƒíƒœ</strong>
            <span style="font-size: 1.1rem;">{{ exam_result.status }}</span>
        </div>
    </div>
</div>

<!-- ë¶„ì•¼ë³„ ì„±ì  ë¹„êµ ê·¸ë˜í”„ -->
<div class="card">
    <h3>ë¶„ì•¼ë³„ ì„±ì  ë¹„êµ</h3>
    <div class="chart-container">
        <canvas id="examDetailChart"></canvas>
    </div>
    <p id="noDataDetailMessage" style="display: none; color: #d32f2f; text-align: center;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
</div>

<!-- ë¶„ì•¼ë³„ ì ìˆ˜ ìƒì„¸ -->
<div class="card">
    <h3>ë¶„ì•¼ë³„ ì ìˆ˜</h3>
    <ul>
        {% if exam_result.field1_definition or exam_result.field1 %}
        <li>
            <strong>{{ exam_result.field1_definition.name|default:'ë¶„ì•¼ 1' }}:</strong>
            <span style="float: right; font-weight: 600;">{{ exam_result.field1 }}ì </span>
        </li>
        {% endif %}
        {% if exam_result.field2_definition or exam_result.field2 %}
        <li>
            <strong>{{ exam_result.field2_definition.name|default:'ë¶„ì•¼ 2' }}:</strong>
            <span style="float: right; font-weight: 600;">{{ exam_result.field2 }}ì </span>
        </li>
        {% endif %}
        {% if exam_result.field3_definition or exam_result.field3 %}
        <li>
            <strong>{{ exam_result.field3_definition.name|default:'ë¶„ì•¼ 3' }}:</strong>
            <span style="float: right; font-weight: 600;">{{ exam_result.field3 }}ì </span>
        </li>
        {% endif %}
        {% if exam_result.field4_definition or exam_result.field4 %}
        <li>
            <strong>{{ exam_result.field4_definition.name|default:'ë¶„ì•¼ 4' }}:</strong>
            <span style="float: right; font-weight: 600;">{{ exam_result.field4 }}ì </span>
        </li>
        {% endif %}
        {% if exam_result.field5_definition or exam_result.field5 %}
        <li>
            <strong>{{ exam_result.field5_definition.name|default:'ë¶„ì•¼ 5' }}:</strong>
            <span style="float: right; font-weight: 600;">{{ exam_result.field5 }}ì </span>
        </li>
        {% endif %}
    </ul>
</div>

<!-- ë²„íŠ¼ -->
<div style="margin: 1.5rem 0;">
    <a href="{% url 'download_exam_pdf' exam_result.id %}" class="btn" target="_blank">ğŸ“„ PDF ë‹¤ìš´ë¡œë“œ</a>
    <a href="{% url 'parent_dashboard' %}" class="btn btn-secondary">ë’¤ë¡œ ê°€ê¸°</a>
</div>

<!-- Chart.js ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    window.onload = function () {
        var fieldLabels = [];
        var studentFieldScores = [];
        var classFieldAverages = [];

        // ê° ë¶„ì•¼ë³„ ì ìˆ˜ì™€ í•´ë‹¹ ì‹œí—˜ì˜ ë°˜ í‰ê·  ë¶„ì•¼ë³„ ì ìˆ˜ë¥¼ ìˆ˜ì§‘.
        {% if exam_result.field1 %}
            fieldLabels.push("{{ exam_result.field1_definition.name|default:'ë¶„ì•¼ 1' }}");
            studentFieldScores.push({{ exam_result.field1 }});
            classFieldAverages.push({{ exam_result.exam.avg_field1 }});
        {% endif %}
        {% if exam_result.field2 %}
            fieldLabels.push("{{ exam_result.field2_definition.name|default:'ë¶„ì•¼ 2' }}");
            studentFieldScores.push({{ exam_result.field2 }});
            classFieldAverages.push({{ exam_result.exam.avg_field2 }});
        {% endif %}
        {% if exam_result.field3 %}
            fieldLabels.push("{{ exam_result.field3_definition.name|default:'ë¶„ì•¼ 3' }}");
            studentFieldScores.push({{ exam_result.field3 }});
            classFieldAverages.push({{ exam_result.exam.avg_field3 }});
        {% endif %}
        {% if exam_result.field4 %}
            fieldLabels.push("{{ exam_result.field4_definition.name|default:'ë¶„ì•¼ 4' }}");
            studentFieldScores.push({{ exam_result.field4 }});
            classFieldAverages.push({{ exam_result.exam.avg_field4 }});
        {% endif %}
        {% if exam_result.field5 %}
            fieldLabels.push("{{ exam_result.field5_definition.name|default:'ë¶„ì•¼ 5' }}");
            studentFieldScores.push({{ exam_result.field5 }});
            classFieldAverages.push({{ exam_result.exam.avg_field5 }});
        {% endif %}

        var ctx = document.getElementById("examDetailChart").getContext("2d");
        var chartData = {};

        if (fieldLabels.length > 0) {
            chartData = {
                labels: fieldLabels,
                datasets: [
                    {
                        label: "í•™ìƒ ì ìˆ˜",
                        data: studentFieldScores,
                        backgroundColor: "rgba(173, 216, 230, 0.7)",  // íŒŒìŠ¤í…” ë¸”ë£¨
                        borderColor: "rgba(173, 216, 230, 1)",
                        borderWidth: 1
                    },
                    {
                        label: "ë°˜ í‰ê· ",
                        data: classFieldAverages,
                        backgroundColor: "rgba(255, 182, 193, 0.7)",  // íŒŒìŠ¤í…” í•‘í¬
                        borderColor: "rgba(255, 182, 193, 1)",
                        borderWidth: 1
                    }
                ]
            };
        } else {
            // ë§Œì•½ ê° ë¶„ì•¼ì— ëŒ€í•œ ë°ì´í„°ê°€ ì—†ë‹¤ë©´ ì „ì²´ ì´ì  ë¹„êµ
            chartData = {
                labels: ["í•™ìƒ ì´ì ", "ë°˜ í‰ê· "],
                datasets: [
                    {
                        label: "ì„±ì  ë¹„êµ",
                        data: [{{ exam_result.total_score|default:"0" }}, {{ exam_result.exam.average|default:"0" }}],
                        backgroundColor: ["rgba(173, 216, 230, 0.7)", "rgba(255, 182, 193, 0.7)"],
                        borderColor: ["rgba(173, 216, 230, 1)", "rgba(255, 182, 193, 1)"],
                        borderWidth: 1
                    }
                ]
            };
        }

        new Chart(ctx, {
            type: "bar",
            data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: {
                            font: {
                                size: 13,
                                family: "'Segoe UI', sans-serif"
                            },
                            color: '#2c2c2c',
                            padding: 15
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        },
                        ticks: {
                            color: '#6b6b6b'
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        },
                        ticks: {
                            color: '#6b6b6b'
                        }
                    }
                }
            }
        });
    };
</script>
{% endblock %}
