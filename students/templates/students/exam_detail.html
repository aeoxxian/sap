{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">
  <h2>{{ exam_result.exam.name }} ({{ exam_result.exam.date|date:"Yë…„ mì›” dì¼" }})</h2>

  <div class="card mb-3">
    <div class="card-body">
      <p><strong>ì´ì :</strong> {{ exam_result.total_score }} / {{ exam_result.max_score }}</p>
      <p><strong>ë°˜ í‰ê· :</strong> {{ exam_result.exam.average }}</p>
      <p><strong>ì„ì°¨:</strong> {{ exam_result.rank }}</p>
      <p><strong>ì‘ì‹œ ìƒíƒœ:</strong> {{ exam_result.status }}</p>
    </div>
  </div>

  <!-- ë¶„ì•¼ë³„ ì„±ì  ë¹„êµ ê·¸ë˜í”„ -->
  <div class="card mb-3">
    <div class="card-body">
      <h5 class="card-title">ë¶„ì•¼ë³„ ì„±ì  ë¹„êµ ê·¸ë˜í”„</h5>
      <div style="width: 80%; max-width: 800px; height: 400px; margin: auto;">
        <canvas id="examDetailChart"></canvas>
      </div>
      <p id="noDataDetailMessage" style="display: none; color: red;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
    </div>
  </div>

  <div class="card mb-3">
    <div class="card-body">
      <h5 class="card-title">ë¶„ì•¼ë³„ ì ìˆ˜</h5>
      <ul>
        {% if exam_result.field1_definition %}
          <li><strong>{{ exam_result.field1_definition.name }}:</strong> {{ exam_result.field1 }}</li>
        {% elif exam_result.field1 %}
          <li><strong>ë¶„ì•¼ 1:</strong> {{ exam_result.field1 }}</li>
        {% endif %}
        {% if exam_result.field2_definition %}
          <li><strong>{{ exam_result.field2_definition.name }}:</strong> {{ exam_result.field2 }}</li>
        {% elif exam_result.field2 %}
          <li><strong>ë¶„ì•¼ 2:</strong> {{ exam_result.field2 }}</li>
        {% endif %}
        {% if exam_result.field3_definition %}
          <li><strong>{{ exam_result.field3_definition.name }}:</strong> {{ exam_result.field3 }}</li>
        {% elif exam_result.field3 %}
          <li><strong>ë¶„ì•¼ 3:</strong> {{ exam_result.field3 }}</li>
        {% endif %}
        {% if exam_result.field4_definition %}
          <li><strong>{{ exam_result.field4_definition.name }}:</strong> {{ exam_result.field4 }}</li>
        {% elif exam_result.field4 %}
          <li><strong>ë¶„ì•¼ 4:</strong> {{ exam_result.field4 }}</li>
        {% endif %}
        {% if exam_result.field5_definition %}
          <li><strong>{{ exam_result.field5_definition.name }}:</strong> {{ exam_result.field5 }}</li>
        {% elif exam_result.field5 %}
          <li><strong>ë¶„ì•¼ 5:</strong> {{ exam_result.field5 }}</li>
        {% endif %}
      </ul>
    </div>
  </div>

  <!-- PDF ë‹¤ìš´ë¡œë“œ ë° ë’¤ë¡œ ê°€ê¸° ë²„íŠ¼ -->
  <div class="mb-3">
    <a href="{% url 'download_exam_pdf' exam_result.id %}" class="btn btn-primary" target="_blank">ğŸ“„ PDF ë‹¤ìš´ë¡œë“œ</a>
    <a href="{% url 'parent_dashboard' %}" class="btn btn-secondary">ë’¤ë¡œ ê°€ê¸°</a>
  </div>
</div>

<!-- Chart.js ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    window.onload = function () {
        var fieldLabels = [];
        var studentFieldScores = [];
        var classFieldAverages = [];

        // ê° ë¶„ì•¼ë³„ ì ìˆ˜ì™€ í•´ë‹¹ ì‹œí—˜ì˜ ë°˜ í‰ê·  ë¶„ì•¼ë³„ ì ìˆ˜ë¥¼ ìˆ˜ì§‘.
        {% if exam_result.field1 %}
            fieldLabels.push("{{ exam_result.field1_definition.name|default:'ë¶„ì•¼ 1' }}");
            studentFieldScores.push({{ exam_result.field1 }});
            classFieldAverages.push({{ exam_result.exam.avg_field1 }});
        {% endif %}
        {% if exam_result.field2 %}
            fieldLabels.push("{{ exam_result.field2_definition.name|default:'ë¶„ì•¼ 2' }}");
            studentFieldScores.push({{ exam_result.field2 }});
            classFieldAverages.push({{ exam_result.exam.avg_field2 }});
        {% endif %}
        {% if exam_result.field3 %}
            fieldLabels.push("{{ exam_result.field3_definition.name|default:'ë¶„ì•¼ 3' }}");
            studentFieldScores.push({{ exam_result.field3 }});
            classFieldAverages.push({{ exam_result.exam.avg_field3 }});
        {% endif %}
        {% if exam_result.field4 %}
            fieldLabels.push("{{ exam_result.field4_definition.name|default:'ë¶„ì•¼ 4' }}");
            studentFieldScores.push({{ exam_result.field4 }});
            classFieldAverages.push({{ exam_result.exam.avg_field4 }});
        {% endif %}
        {% if exam_result.field5 %}
            fieldLabels.push("{{ exam_result.field5_definition.name|default:'ë¶„ì•¼ 5' }}");
            studentFieldScores.push({{ exam_result.field5 }});
            classFieldAverages.push({{ exam_result.exam.avg_field5 }});
        {% endif %}

        var ctx = document.getElementById("examDetailChart").getContext("2d");
        var chartData = {};

        if (fieldLabels.length > 0) {
            chartData = {
                labels: fieldLabels,
                datasets: [
                    {
                        label: "í•™ìƒ ì ìˆ˜",
                        data: studentFieldScores,
                        backgroundColor: "rgba(54, 162, 235, 0.5)",
                        borderColor: "rgba(54, 162, 235, 1)",
                        borderWidth: 1
                    },
                    {
                        label: "ë°˜ í‰ê· ",
                        data: classFieldAverages,
                        backgroundColor: "rgba(255, 99, 132, 0.5)",
                        borderColor: "rgba(255, 99, 132, 1)",
                        borderWidth: 1
                    }
                ]
            };
        } else {
            // ë§Œì•½ ê° ë¶„ì•¼ì— ëŒ€í•œ ë°ì´í„°ê°€ ì—†ë‹¤ë©´ ì „ì²´ ì´ì  ë¹„êµ
            chartData = {
                labels: ["í•™ìƒ ì´ì ", "ë°˜ í‰ê· "],
                datasets: [
                    {
                        label: "ì„±ì  ë¹„êµ",
                        data: [{{ exam_result.total_score|default:"0" }}, {{ exam_result.exam.average|default:"0" }}],
                        backgroundColor: ["rgba(54, 162, 235, 0.5)", "rgba(255, 99, 132, 0.5)"],
                        borderColor: ["rgba(54, 162, 235, 1)", "rgba(255, 99, 132, 1)"],
                        borderWidth: 1
                    }
                ]
            };
        }

        new Chart(ctx, {
            type: "bar",
            data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100
                    }
                }
            }
        });
    };
</script>
{% endblock %}
